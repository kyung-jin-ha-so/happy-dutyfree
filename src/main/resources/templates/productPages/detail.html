<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>
<body>
상품 상세 정보

<div class="container">
    <table class="table">
        <tr>
            <th>상품번호</th>
            <th>이름</th>
            <th>상세설명</th>
            <th>원가</th>
            <th>할인율</th>
            <th>인터넷할인가</th>
            <th>인터넷원화</th>
            <th>썸네일</th>
            <th>수량</th>
            <th>찜하기</th>
            <th>장바구니 담기</th>
            <th>바로구매</th>
        </tr>
        <tr>
            <td th:text="${product.productId}"></td>
            <td th:text="${product.productName}"></td>
            <td th:text="${product.productDesc}"></td>
            <td><STRIKE th:text="${product.productOriginalPrice}"></STRIKE></td>
            <td th:text="${product.productDiscount}"></td>
            <td th:text="${product.productPrice}"></td>
            <td th:text="${#numbers.formatInteger(exchangeRateDTO.exchangeRate*product.productPrice, 3, 'COMMA')} + '원'"></td>
            <td><img th:src="@{|/upload/${product.productThumbnail}|}" width="100" height="100" alt=""></td>
            <td>
                <button type="button" class="minus_btn" onclick="qtyCount('minus')">-</button>
                <input type="text" id="productQty" value="1" readonly="readonly" style="text-align:center;"/>
                <button type ="button" class="plus_btn" onclick="qtyCount('plus')">+</button>
            </td>
            <td th:if="${like == null}">
                <i class="bi bi-heart" onclick="saveWish()"></i></td>
            <td th:if="${like != null}">
                <i class="bi bi-heart-fill" onclick="deleteWish()"></i></td>
            <td><input type="button" onclick="addToCart()" value="장바구니 담기"></a></td>
            <td><input type="button" onclick="addToOrder()" value="주문하기"></a></td>
        </tr>
    </table>

<!--    <div th:each="${session.loginEmail == 'admin'}">-->
        <a th:href="@{|/product/update/${product.productId}|}">수정</a>
<!--    </div>-->

    상세 설명이미지
    <div th:each="productFile: ${product.productFilesEntityList}" >
        <img th:src="@{|/upload/${productFile.productFileName}|}" alt="">
    </div>
</div>

<div>
    상품 후기
    <table class="table">
        <tr>
            <th>상품후기 번호</th>
            <th>상품후기 작성자</th>
            <th>상품후기 작성내용</th>
            <th>상품후기 별점</th>
            <th>상품후기 작성시간</th>
        </tr>
        <tr th:each="productReview: ${product.reviewEntityList}">
            <td th:text="${productReview.reviewId}"></td>
            <td th:text="${productReview.memberEntity.memberId}"></td>
            <td th:text="${productReview.reviewContents}"></td>
            <td th:text="${productReview.reviewStar}"></td>
            <td th:text="${productReview.getCreatedTime()}"></td>
        </tr>
    </table>

</div>
</body>
<script th:inline="javascript">
    function saveWish() {
        if ([[${session.loginEmail}]] == null) {
            alert("로그인 후 찜하실 수 있습니다");
            location.href = "/member/login";
        } else {
            let memberId = [[${session.loginId}]];
            let productId = [[${product.productId}]];
            $.ajax({
                type: "post",
                url: "/product/like",
                data: {
                    "memberId": memberId,
                    "productId": productId
                },
                dataType: "text",
                success: function (result) {
                    alert("찜하기 성공")
                    location.reload();
                }, error: function () {
                    alert("찜하기 실패")
                    location.reload();
                }
            })
        }
    }

    function deleteWish() {
        if ([[${session.loginEmail}]] == null) {
            alert("로그인 후 찜하실 수 있습니다");
            location.href = "/member/login";
        } else {
            let memberId = [[${session.loginId}]];
            let productId = [[${product.productId}]];
            $.ajax({
                type: "post",
                url: "/product/dontLike",
                data: {
                    "memberId": memberId,
                    "productId": productId
                },
                dataType: "text",
                success: function (result) {
                    alert("찜취소 성공")
                    location.reload();
                }, error: function () {
                    alert("찜 취소 실패");
                    location.reload();
                }
            })
        }
    }

    function addToCart() {
        console.log("addToCart함수실행됨")
        const cartQty = document.getElementById("productQty").value;
        const memberId = [[${session.loginId}]];
        const productId = [[${product.productId}]];
        if ([[${session.loginEmail}]] == null) {
            alert("로그인 후 이용할실 수 있습니다.");
            location.href = "/member/login";
        } else if ([[${cart}]] == null) {
            console.log("null로 찍힘")
            $.ajax({
                type: "get",
                url: "/cart/save",
                data: {
                    "memberId": memberId,
                    "productId": productId,
                    "cartQty": cartQty
                },
                dataType: "text",
                success: function (result) {
                    alert("장바구니 담기")
                    location.reload();
                }, error: function () {
                    alert("장바구니 담기 실패")
                }
            })
        } else if ([[${cart}]] != null) {
            console.log("else if 들어옴")
            if (confirm("장바구니에 동일한 상품이 있습니다. 장바구니에 추가하시겠습니까?")) {
                $.ajax({
                    type: "get",
                    url: "/cart/addToCart",
                    data: {
                        "memberId": memberId,
                        "productId": productId,
                        "cartQty": cartQty
                    },
                    dataType: "text",
                    success: function () {
                        alert("장바구니 담기")
                        location.reload();
                    }, error: function () {
                        alert("장바구니 담기 실패")
                    }
                })
            } else {
                location.reload();
            }
        }
    }

    function qtyCount(type){
        const productQty = document.getElementById("productQty");

        if(type=='plus'){
            productQty.value = Number(productQty.value)+1;
        }else{
            if(productQty.value > 1){
                productQty.value = Number(productQty.value)-1;
            }
        }
    }

    function addToOrder() {
        const productId = [[${product.productId}]];
        const orderQty = document.getElementById("productQty").value;
        location.href = "/order/save-form&?orderQty="+orderQty+"&?productId="+productId;
    }
</script>
</html>