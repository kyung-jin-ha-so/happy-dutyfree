<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>

    <style>
        * {
            box-size: border-box;
            border-collapse: collapse;
            text-align: center;
            position: relative;
        }

        .container-title {
            background-color: pink;
            display: block;
            margin: 50px auto 0;
            position: relative;
            width: 900px;
        }

        .thumbnail-container {
            width: 100%;
            vertical-align: middle;
            position: relative;
        }

        .file-container {
            width: 100%;
        }

        .coupon-container {
            width: 100%;
        }
    </style>
    <title>Title</title>
</head>
<body>
<div class="container-title">
    <div class="thumbnail-container">
        <a href="#" class="img-link">
            <img th:src="@{|/upload/${event.eventThumbnailName}|}" alt="">
        </a>
    </div>
    <div class="file-container">
        <div th:each="eventFile: ${event.eventFilesEntityList}">
            <img th:src="@{|/upload/${eventFile.eventFileName}|}" alt="">
        </div>
    </div>
    <div class="coupon-container">
        <div th:if="${couponMember == null}"><img th:src="@{|/upload/${event.couponEntity.couponThumbnail}|}"
                                                  alt=""
                                                  onclick="issueCoupon()"></div>
        <div th:if="${couponMember != null}"><img th:src="@{|/upload/${event.couponEntity.couponThumbnail}|}"
                                                  alt=""
                                                  onclick="dontIssueCoupon()"></div>
    </div>
</div>
</div>
</body>
<script>
    const eventDelete = () => {
        const eventId = [[${event.eventId}]]
        location.href = "/event/delete/" + eventId;
    }
    const eventUpdate = () => {
        const eventId = [[${event.eventId}]]
        location.href = "/event/update/" + eventId;
    }
</script>
<script th:inline="javascript">
    function issueCoupon() {
        console.log("함수 들어옴")
        const couponName = document.getElementById("couponName").innerHTML;
        console.log(couponName);
        const memberId = [[${session.loginId}]];
        const couponId = [[${event.couponEntity.couponId}]];
        const memberB = [[${member.memberBirth}]];
        let today = new Date();
        let month = today.getMonth() + 1;  // 월
        if (month < 10) {
            month = "0" + month;
        }
        let date = today.getDate();  // 날짜
        // 노조건 이벤트
        if (couponName == "조건없음") {
            console.log("조건부합함")
            $.ajax({
                type: "post",
                url: "/coupon/issueCoupon/",
                data: {
                    "memberId": memberId,
                    "couponId": couponId,
                },
                dataType: "text",
                success: function (result) {
                    alert("쿠폰발급 성공")
                    location.reload();
                }, error: function () {
                    alert("쿠폰 발급 조건에 부합하지 않습니다.")
                }
            });
        }
        //생일 이벤트
        if (couponName == "생일") {
            let todayDate = month + '-' + date;
            let memberBirth = memberB.substring(5, 10);
            if (memberBirth == todayDate) {
                console.log("둘이 같음")
                $.ajax({
                    type: "post",
                    url: "/coupon/issueCoupon/",
                    data: {
                        "memberId": memberId,
                        "couponId": couponId,
                    },
                    dataType: "text",
                    success: function (result) {
                        alert("쿠폰발급 성공")
                        location.reload();
                    }, error: function () {
                        alert("쿠폰 발급 조건에 부합하지 않습니다.")
                    }
                });
            } else {
                alert("쿠폰 발급 조건에 부합하지 않습니다.")
            }
        }
        //띠 조건 이벤트
        if (couponName == "띠") {
            let memberYear = parseInt(memberB.substring(0, 4));
            let year = today.getFullYear();
            console.log(memberYear);
            console.log(year);
            if (memberYear % 12 == year % 12) {
                console.log("if문 들어옴")
                $.ajax({
                    type: "post",
                    url: "/coupon/issueCoupon/",
                    data: {
                        "memberId": memberId,
                        "couponId": couponId,
                    },
                    dataType: "text",
                    success: function (result) {
                        alert("쿠폰발급 성공")
                        location.reload();
                    }, error: function () {
                        alert("쿠폰 발급 조건에 부합하지 않습니다.")
                    }
                });
            } else {
                console.log("else문 들어옴")
                alert("쿠폰 발급 조건에 부합하지 않습니다.")
            }
        }
    }

    function dontIssueCoupon() {
        alert("이미 보유하고 있는 쿠폰입니다.")
    }
</script>
</html>